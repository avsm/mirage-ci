FROM ocurrent/opam:alpine-3.12-ocaml-4.07
RUN sudo apk add --update docker
RUN git -C /home/opam/opam-repository pull origin master && opam update -uy
RUN opam depext -uivy asetmap.0.8.1 asn1-combinators.0.2.2 astring.0.8.5 atd.2.0.0 atdgen.2.0.0 atdgen-runtime.2.0.0 base.v0.13.2 base-bigarray.base base-bytes.base base-threads.base base-unix.base base64.3.2.0 bigarray-compat.1.0.0 biniou.1.2.1 bos.0.2.0 calendar.2.04 camomile.1.0.2 charInfo_width.1.1.0 cmdliner.1.0.4 cohttp.2.5.4 cohttp-lwt.2.1.3 cohttp-lwt-unix.2.1.3 conduit.1.5.0 conduit-lwt.1.5.0 conduit-lwt-unix.1.5.0 conf-gmp.1 conf-libev.4-11 conf-m4.1 conf-perl.1 cppo.1.6.6 cppo_ocamlbuild.1.6.6 cpuid.0.1.2 crunch.3.2.0 cstruct.5.1.1 cstruct-lwt.5.1.1 cstruct-sexp.5.1.1 datakit-ci.1.0.0 datakit-client.1.0.0 datakit-client-9p.1.0.0 datakit-client-git.1.0.0 datakit-github.1.0.0 decompress.0.7 dispatch.0.4.1 domain-name.0.3.0 dune.1.11.4 dune-configurator.1.0.0 easy-format.1.3.2 ezjsonm.1.1.0 fieldslib.v0.13.0 fmt.0.8.8 fpath.0.7.2 git.1.11.5 git-http.1.11.4 git-unix.1.11.5 github.4.3.1 github-unix.4.3.1 hex.1.4.0 io-page.2.3.0 io-page-unix.2.3.0 ipaddr.5.0.0 ipaddr-sexp.5.0.0 irmin.1.4.0 irmin-fs.1.3.0 irmin-git.1.3.0 irmin-http.1.3.3 irmin-mem.1.3.0 irmin-unix.1.3.3 irmin-watcher.0.3.0 jbuilder.transition jsonm.1.0.1 lambda-term.3.1.0 logs.0.7.0 lwt.5.2.0 lwt_log.1.1.1 lwt_ppx.2.0.1 lwt_react.1.1.3 macaddr.5.0.0 magic-mime.1.1.2 menhir.20190924 mew.0.1.0 mew_vi.0.5.0 mirage-channel.3.2.0 mirage-channel-lwt.3.2.0 mirage-clock.2.0.0 mirage-device.1.2.0 mirage-flow.1.6.0 mirage-flow-lwt.1.6.0 mirage-no-solo5.1 mirage-no-xen.1 mmap.1.1.0 mstruct.1.4.0 mtime.1.2.0 multipart-form-data.0.2.0 nocrypto.0.5.4-2 num.1.3 ocaml.4.07.1 ocaml-base-compiler.4.07.1 ocaml-compiler-libs.v0.12.1 ocaml-config.1 ocaml-migrate-parsetree.1.7.3 ocamlbuild.0.14.0 ocamlfind.1.8.1 ocamlgraph.1.8.8 ocb-stubblr.0.1.1-1 ocplib-endian.1.1 parsexp.v0.13.0 pbkdf.1.0.0 ppx_cstruct.5.1.1 ppx_derivers.1.2.1 ppx_deriving.4.2.1 ppx_fields_conv.v0.13.0 ppx_sexp_conv.v0.13.0 ppx_tools.5.1+4.06.0 ppx_tools_versioned.5.4.0 ppxlib.0.13.0 prometheus.0.7 prometheus-app.0.7 protocol-9p.2.0.1 protocol-9p-unix.2.0.1 ptime.0.8.5 re.1.9.0 react.1.2.1 redis.0.4 redis-lwt.0.4 result.1.4 rresult.0.6.0 seq.base session.0.4.1 session-cohttp.0.4.1 session-redis-lwt.0.4.1 session-webmachine.0.4.1 sexplib.v0.13.0 sexplib0.v0.13.0 stdio.v0.13.0 stdlib-shims.0.1.0 stringext.1.6.0 tls.0.10.2 topkg.1.0.2 trie.1.0.0 tyxml.4.4.0 uchar.0.0.2 uri.3.1.0 uri-sexp.3.1.0 uuidm.0.9.7 uutf.1.0.2 webmachine.0.5.0 win-error.1.0 x509.0.6.3 yojson.1.7.0 zarith.1.9.1 zed.3.1.0
ADD --chown=1000 mirage-ci.opam /home/opam/src/
RUN opam install --deps-only /home/opam/src/
ADD --chown=1000 . /home/opam/src
RUN opam pin add -n mirage-ci.dev /home/opam/src
RUN opam pin add -n ocaml-version.dev git://github.com/avsm/ocaml-version.git
RUN opam install -vy ocaml-version.dev mirage-ci.dev
ENV CONDUIT_TLS=native
ENV OCAMLRUNPARAM=b
USER root
CMD []
